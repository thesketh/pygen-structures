---
title: 'pygen-structures: A Python package to generate 3D molecular structures for simulations using the CHARMM forcefield'
tags:
  - python
  - computational chemistry
  - chemistry
  - molecular dynamics
authors:
 - name: Travis Hesketh
   orcid: 0000-0002-0502-9596
   affiliation: 1
affiliations:
 - name: University of Strathclyde
   index: 1
date: 28 February 2020
bibliography: paper.bib
---

# Statement of Need

Forcefields used in molecular dynamics (MD) or Monte Carlo simulations (such as the CHARMM forcefield, @charmm) require a great deal of information in order to ensure that the correct harmonic force constants are chosen for particular bonds or angles. As such, protein structure files (PSF files), containing information about connectivity and relevant parameters, are often used by simulation packages to contain this information. These files are typically generated using _psfgen_, [@psfgen] a Tcl package bundled with _VMD_ [@vmd] which requires a fully annotated Protein Data Bank (PDB) format file [@wwPDB2012] with correct names for atoms and residues, as defined in the forcefield. This annotation is challenging to do in an automated fashion. For structures from the Protein Data Bank itself, this is expected to some degree, as experimentally resolved structures are often missing the coordinates of certain residues [@Brunger1993] and can contain bound ligands which may not be parameterised in the forcefield. At present, the normal solution to this problem is to download a structure from the database, manually fix residue and atom names, and generate a PSF file using psfgen. In other words, obtaining a 3D structure, annotating the structure and generating an input file in the correct format for a simulation package are treated as separate tasks.

For simulations involving combinatorial searches of smaller sequences, however, the level of human intervention required can be far greater. There may be no experimentally determined structures for a given sequence, so these must be generated. Tools which are capable of generating 3D conformations of such molecules must be applicable more generally than molecular dynamics forcefields, and as a result are far less specific about the identities of particular atoms. As such, these packages often leave residue and atom names labelled as unknowns or element symbols. Additionally, if structures are generated based only on connectivity or drawn by the user, it can be challenging to ensure that tetrahedral chirality (the _handedness_ of carbon centres with four different substituents) is properly respected. A structure generation method for small molecules which is aware of the forcefield is necessary in order to automate this process. The workflow which `pygen-structures` hopes to automate is shown in Figure 1.

![An example workflow used to prepare structures for molecular dynamics or Monte Carlo simulation. For smaller polymeric structures, `pygen-structures` can be used to prevent the need for significant manual intervention.](Figures/WorkflowFlowchart.png)

# Summary

`pygen-structures` is an open source (3-clause BSD license) Python library to work with molecules from the CHARMM forcefield, generating 3 dimensional structures for them based on empirical data (@Riniker2015, as implemented in the _RDKit_, @rdkit), writing out standard PSF and PDB files. The package contains convenience functions for generating arbitrary molecules from a collection of CHARMM residues and patches, or from one letter amino acid codes (this functionality is usable by calling `pygen-structures` as a command line application) and a series of classes and functions for representing and manipulating CHARMM data. The chirality of tetrahedral centres is set using internal coordinate data from the residue topology file.

Classes provided by `pygen-structures` include representations of CHARMM residue topology files, which contain information about residues, their atoms and their connectivity; and parameter files, containing the relevant force constants involving sets of atoms. There are also classes which describe residues and patches from topology files, and representations of atoms and molecules. Residues from the forcefield (and molecules created from those residues) can be represented as RDKit `Mol`s, enabling pattern matching of residues to molecules.

## Problems With Current Workflows

To illustrate the current necessity of human involvement in annotation of small-molecule structures, it is useful to examine those which are created by other software packages. The following is a PDB file generated by drawing the structure of phenylalanine in _MarvinSketch_ 20.3 and cleaning the structure in 3D. This is representative of many chemical drawing packages, which aim to work with as many areas of general chemistry as possible.

```
HEADER    PROTEIN                                 25-FEB-20   NONE
TITLE     NULL                                                        
COMPND    NULL                                                        
SOURCE    NULL                                                        
KEYWDS    NULL                                                        
EXPDTA    NULL                                                        
AUTHOR    Marvin                                                      
REVDAT   1   25-FEB-20         0                                  
HETATM    1  C   UNK     0       1.322   4.682   0.738  0.00  0.00           C+0
HETATM    2  C   UNK     0      -0.092   4.630   0.732  0.00  0.00           C+0
HETATM    3  C   UNK     0      -0.852   5.626   1.374  0.00  0.00           C+0
HETATM    4  C   UNK     0      -0.210   6.682   2.043  0.00  0.00           C+0
HETATM    5  C   UNK     0       1.194   6.742   2.065  0.00  0.00           C+0
HETATM    6  C   UNK     0       1.956   5.751   1.415  0.00  0.00           C+0
HETATM    7  C   UNK     0       2.119   3.650   0.016  0.00  0.00           C+0
HETATM    8  C   UNK     0       2.390   4.043  -1.467  0.00  0.00           C+0
HETATM    9  C   UNK     0       3.204   3.058  -2.216  0.00  0.00           C+0
HETATM   10  N   UNK     0       1.121   4.261  -2.184  0.00  0.00           N+1
HETATM   11  O   UNK     0       3.531   3.283  -3.404  0.00  0.00           O+0
HETATM   12  O   UNK     0       3.645   1.907  -1.656  0.00  0.00           O-1
MASTER        0    0    0    0    0    0    0    0   12    0    0    0
END
```

Note the lack of annotation in the PDB atom names (labelled as their element symbol) and residue names ('`UNK`'). This information would need to be annotated manually in order to run an MD simulation. In the RDKit, structures for simple protein sequences can be generated by reading an amino acid sequence:

```python
>>> from rdkit import Chem
>>> from rdkit.Chem import AllChem
>>> mol = Chem.MolFromSequence('F')
>>> AllChem.EmbedMolecule(mol, AllChem.ETKDGv2())
0
>>> print(Chem.MolToPDBBlock(mol))
ATOM      1  N   PHE A   1      -2.664  -1.853   0.236  1.00  0.00           N  
ATOM      2  CA  PHE A   1      -1.340  -1.105   0.789  1.00  0.00           C  
ATOM      3  C   PHE A   1      -1.982   0.347   0.875  1.00  0.00           C  
ATOM      4  O   PHE A   1      -3.045   0.666   0.443  1.00  0.00           O  
ATOM      5  CB  PHE A   1      -0.777  -0.919  -0.748  1.00  0.00           C  
ATOM      6  CG  PHE A   1       0.505  -0.247  -0.694  1.00  0.00           C  
ATOM      7  CD1 PHE A   1       1.621  -1.079  -0.546  1.00  0.00           C  
ATOM      8  CD2 PHE A   1       0.787   1.081  -0.783  1.00  0.00           C  
ATOM      9  CE1 PHE A   1       2.896  -0.556  -0.497  1.00  0.00           C  
ATOM     10  CE2 PHE A   1       2.054   1.623  -0.737  1.00  0.00           C  
ATOM     11  CZ  PHE A   1       3.120   0.793  -0.592  1.00  0.00           C  
ATOM     12  OXT PHE A   1      -1.176   1.249   1.519  1.00  0.00           O  
CONECT    1    2
CONECT    2    3    5
CONECT    3    4    4   12
CONECT    5    6
CONECT    6    7    7    8
CONECT    7    9
CONECT    8   10   10
CONECT    9   11   11
CONECT   10   11
END
```

The level of annotation is greater, but hydrogen atom positions are not added (were these to be added using `Chem.AddHs`, they would be incorrectly annotated) and the atom names do not match the CHARMM atom names exactly (though they do follow the standard PDB naming conventions, so it would be trivial to correct them). psfgen is capable of assigning the positions of hydrogen atoms and setting the correct charge states, so this approach works reasonably well for simple L-amino sequences. It is, however, nontrivial to generate mixtures of D and L amino acids, as acid chirality is set using a flag argument to `Chem.MolFromSequence`.

With `pygen-structures`, it is easily possible to generate the structures of free amino acids, peptides, or more complex structures such as glycans and glycopeptides, in an automated fashion. A significant advantage is that it is no longer necessary to use psfgen to generate the PSF file. This greatly simplifies combinatorial searches of small molecule sequences.

```python
>>> from pygen_structures import code_to_mol, sequence_to_mol, load_charmm_dir
>>> ## pygen_structures is distributed with the CHARMM35/36 files.
>>> rtf, prm = load_charmm_dir()
>>> mol = code_to_mol('AdAF', rtf)  # L-alanine, D-alanine, L-phenylalanine
>>> print(mol.to_pdb_block())
COMPND    AdAF
AUTHOR    pygen-structures v0.2
ATOM      1   N  ALA     1      -6.082  -0.735   1.391  1.00  0.00      PROT N1+
ATOM      2  HT1 ALA     1      -5.807  -0.157   2.244  1.00  0.00      PROT H  
ATOM      3  HT2 ALA     1      -7.098  -0.635   1.251  1.00  0.00      PROT H  
ATOM      4  HT3 ALA     1      -5.757  -1.714   1.511  1.00  0.00      PROT H  
ATOM      5  CA  ALA     1      -5.408  -0.121   0.253  1.00  0.00      PROT C  
<truncated>
>>> patches = {"RAFF", [0, 1, 2]}
>>> sequence = ['AGLC', 'BFRU', 'AGAL']
>>> mol = sequence_to_mol(
...     sequence,
...     rtf,
...     patches=patches,
...     name='Raffinose'
...     segment_id="RAFF"
... )
>>> print(mol.to_pdb_block())
COMPND    Raffinose
AUTHOR    pygen-structures v0.2
ATOM      1  C1  AGLC    1      -1.645  -0.345  -0.614  1.00  0.00      RAFF C  
ATOM      2  H1  AGLC    1      -1.845   0.725  -0.413  1.00  0.00      RAFF H  
ATOM      3  O1  AGLC    1      -2.764  -1.026  -0.170  1.00  0.00      RAFF O  
ATOM      4  C5  AGLC    1       0.657  -0.321  -0.142  1.00  0.00      RAFF C  
ATOM      5  H5  AGLC    1       1.185  -1.104  -0.707  1.00  0.00      RAFF H  
<truncated>
>>> print(mol.to_psf_block())
PSF CMAP

         2 !NTITLE
* Generated procedurally using pygen-structures v0.2.
* Molecule: Raffinose

      66 !NATOM
       1 RAFF 1    AGLC C1   CC31   0.290000       12.0110           0
       2 RAFF 1    AGLC H1   HCA1   0.090000        1.0080           0
       3 RAFF 1    AGLC O1   OC30  -0.360000       15.9994           0
       4 RAFF 1    AGLC C5   CC31   0.110000       12.0110           0
       5 RAFF 1    AGLC H5   HCA1   0.090000        1.0080           0
<truncated>
```

A downside to this approach is that knowledge of the available CHARMM residues and the required patches is necessary, but this is true of psfgen as well. Some initial work is always required to discover whether CHARMM can represent a molecule of interest. This could be improved through use of automated pattern matching from provided structures, but is challenging due to the incomplete nature of X-ray crystal data.

## Future Work

`pygen-structures` is not yet a fully featured replacement for psfgen. In particular, the present structure generation method fails to fill coordinates for missing residues of large structures (making it impractical to use with protein structures from the PDB).

In future, the aim is to support all of psfgen's current functionality. Further advantageous features would include the generation of simulation boxes containing water and multiple molecules, and an automatic bead-generating method for coarse-grained simulations.

Further documentation, including a writeup of the types of polymeric structures already parameterised in the CHARMM forcefield, could encourage future combinatorial work.

## Dependencies

`pygen-structures` depends upon the RDKit for 3D coordinate generation and uses NumPy for representations of the molecular adjacency matrix. Unit tests (using the Python standard library) are supplied to test the functionality provided by the package. Tests can be run using `from pygen-structures import tests; tests.run()`.

Any modern Python 3 version should be supported, and pip can be used for installation: `pip install pygen-structures`

# Acknowledgements

TH thanks the Strathclyde Computational and Theoretical Chemistry Hub (SCoTCH) at the University of Strathclyde for helpful conversations and enthusiasm, and those that are working to increase recognition of research software engineers.

MarvinSketch was used for 3D coordinate generation in "Problems with Current Workflows", MarvinSketch 20.3, ChemAxon (https://www.chemaxon.com).

# References
